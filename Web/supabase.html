<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-11-03 Mon 10:45 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Supabase</title>
<meta name="generator" content="Org Mode" />
<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
                     <script src="/pagefind/pagefind-ui.js"></script>
                     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
                     <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
                     <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/scheme.min.js"></script
                     <link rel="stylesheet" href="//unpkg.com/@catppuccin/highlightjs@1.0.1/css/catppuccin-frappe.css">
                     <link rel="stylesheet" href="/style.css" type="text/css"/>
                     <script>hljs.highlightAll();</script>

          <style>
          /* From: https://endlessparentheses.com/public/css/endless.css */
          /* See also: https://meta.superuser.com/questions/4788/css-for-the-new-kbd-style */
          kbd
          {
            -moz-border-radius: 6px;
            -moz-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
            -webkit-border-radius: 6px;
            -webkit-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
            background-color: #f7f7f7;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
            color: #333;
            display: inline-block;
            font-family: 'Droid Sans Mono', monospace;
            font-size: 80%;
            font-weight: normal;
            line-height: inherit;
            margin: 0 .1em;
            padding: .08em .4em;
            text-shadow: 0 1px 0 #fff;
            word-spacing: -4px;
        
            box-shadow: 2px 2px 2px #222; /* MA: An extra I've added. */
          }
          </style>
          <link rel="stylesheet" type="text/css" href="https://alhassy.github.io/org-special-block-extras/tooltipster/dist/css/tooltipster.bundle.min.css"/>
        
          <link rel="stylesheet" type="text/css" href="https://alhassy.github.io/org-special-block-extras/tooltipster/dist/css/plugins/tooltipster/sideTip/themes/tooltipster-sideTip-punk.min.css" />
        
          <script type="text/javascript">
              if (typeof jQuery == 'undefined') {
                  document.write(unescape('%3Cscript src="https://code.jquery.com/jquery-1.10.0.min.js"%3E%3C/script%3E'));
              }
          </script>
        
           <script type="text/javascript"            src="https://alhassy.github.io/org-special-block-extras/tooltipster/dist/js/tooltipster.bundle.min.js"></script>
        
            <script>
                   $(document).ready(function() {
                       $('.tooltip').tooltipster({
                           theme: 'tooltipster-punk',
                           contentAsHTML: true,
                           animation: 'grow',
                           delay: [100,500],
                           // trigger: 'click'
                           trigger: 'custom',
                           triggerOpen: {
                               mouseenter: true
                           },
                           triggerClose: {
                               originClick: true,
                               scroll: true
                           }
           });
                   });
               </script>
        
          <style>
             abbr {color: red;}
        
             .tooltip { border-bottom: 1px dotted #000;
                        color:red;
                        text-decoration: none;}
          </style>
</head>
<body>
<div id="preamble" class="status">
<div id="search"></div><div class="breadcrumb"><a href="/">Home</a> <span>â†’</span> <a href="/Web/index.html">Web</a></div>
</div>
<div id="content" class="content">
<h1 class="title">Supabase</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgfa561ea">1. Database</a>
<ul>
<li><a href="#org6a8c0b7">1.1. Update</a></li>
<li><a href="#orge6c2eb5">1.2. Select</a>
<ul>
<li><a href="#orga90ad0f">1.2.1. Filtering</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org17bc3e4">2. Auth</a>
<ul>
<li><a href="#org71e3c04">2.1. Custom Claims</a>
<ul>
<li><a href="#org98a48be">2.1.1. Example: Role-Based Access Control</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgfa561ea" class="outline-2">
<h2 id="orgfa561ea"><span class="section-number-2">1.</span> Database</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org6a8c0b7" class="outline-3">
<h3 id="org6a8c0b7"><span class="section-number-3">1.1.</span> Update</h3>
<div class="outline-text-3" id="text-1-1">
<p>
To update a row in a table, use the <code>update</code> method:
</p>
<pre><code class="language-typescript-ts"><span style="color: #cba6f7;">const</span> <span style="color: #f38ba8;">{</span> <span style="color: #cdd6f4;">data</span><span style="color: #9399b2;">,</span> <span style="color: #cdd6f4;">error</span> <span style="color: #f38ba8;">}</span> <span style="color: #89dceb;">=</span> <span style="color: #cba6f7;">await</span> supabase
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">from</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'members'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">update</span><span style="color: #f38ba8;">(</span><span style="color: #fab387;">{</span> <span style="color: #89b4fa;">other_column</span><span style="color: #9399b2;">:</span> <span style="color: #a6e3a1;">'otherValue'</span> <span style="color: #fab387;">}</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">eq</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'some_column'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'someValue'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">select</span><span style="color: #f38ba8;">()</span>
</code></pre>
</div>
</div>
<div id="outline-container-orge6c2eb5" class="outline-3">
<h3 id="orge6c2eb5"><span class="section-number-3">1.2.</span> Select</h3>
<div class="outline-text-3" id="text-1-2">
<p>
To read rows from a table, use the <code>select</code> method:
</p>
<pre><code class="language-typescript-ts"><span style="color: #6c7086;">// read all rows</span>
<span style="color: #cba6f7;">let</span> <span style="color: #f38ba8;">{</span> <span style="color: #89b4fa;">data</span><span style="color: #9399b2;">:</span> <span style="color: #cdd6f4;">members</span><span style="color: #9399b2;">,</span> <span style="color: #cdd6f4;">error</span> <span style="color: #f38ba8;">}</span> <span style="color: #89dceb;">=</span> <span style="color: #cba6f7;">await</span> supabase
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">from</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'members'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">select</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'*'</span><span style="color: #f38ba8;">)</span>

<span style="color: #6c7086;">// read specific columns</span>
<span style="color: #cba6f7;">let</span> <span style="color: #f38ba8;">{</span> <span style="color: #89b4fa;">data</span><span style="color: #9399b2;">:</span> <span style="color: #cdd6f4;">members</span><span style="color: #9399b2;">,</span> <span style="color: #cdd6f4;">error</span> <span style="color: #f38ba8;">}</span> <span style="color: #89dceb;">=</span> <span style="color: #cba6f7;">await</span> supabase
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">from</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'members'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">select</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'some_column,other_column'</span><span style="color: #f38ba8;">)</span>  
</code></pre>
</div>
<div id="outline-container-orga90ad0f" class="outline-4">
<h4 id="orga90ad0f"><span class="section-number-4">1.2.1.</span> Filtering</h4>
<div class="outline-text-4" id="text-1-2-1">
<pre><code class="language-typescript-ts"><span style="color: #cba6f7;">let</span> <span style="color: #f38ba8;">{</span> <span style="color: #89b4fa;">data</span><span style="color: #9399b2;">:</span> <span style="color: #cdd6f4;">members</span><span style="color: #9399b2;">,</span> <span style="color: #cdd6f4;">error</span> <span style="color: #f38ba8;">}</span> <span style="color: #89dceb;">=</span> <span style="color: #cba6f7;">await</span> supabase
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">from</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'members'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">select</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">"*"</span><span style="color: #f38ba8;">)</span>

  <span style="color: #6c7086;">// Filters</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">eq</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'column'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'Equal to'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">gt</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'column'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'Greater than'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">lt</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'column'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'Less than'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">gte</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'column'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'Greater than or equal to'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">lte</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'column'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'Less than or equal to'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">like</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'column'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'%CaseSensitive%'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">ilike</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'column'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'%CaseInsensitive%'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">is</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'column'</span><span style="color: #9399b2;">,</span> <span style="color: #fab387;">null</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">in</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'column'</span><span style="color: #9399b2;">,</span> <span style="color: #fab387;">[</span><span style="color: #a6e3a1;">'Array'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'Values'</span><span style="color: #fab387;">]</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">neq</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'column'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'Not equal to'</span><span style="color: #f38ba8;">)</span>

  <span style="color: #6c7086;">// Arrays</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">contains</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'array_column'</span><span style="color: #9399b2;">,</span> <span style="color: #fab387;">[</span><span style="color: #a6e3a1;">'array'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'cxontains'</span><span style="color: #fab387;">]</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">containedBy</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'array_column'</span><span style="color: #9399b2;">,</span> <span style="color: #fab387;">[</span><span style="color: #a6e3a1;">'contained'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'by'</span><span style="color: #fab387;">]</span><span style="color: #f38ba8;">)</span>

  <span style="color: #6c7086;">// Logical operators</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">not</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'column'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'like'</span><span style="color: #9399b2;">,</span> <span style="color: #a6e3a1;">'Negate filter'</span><span style="color: #f38ba8;">)</span>
  <span style="color: #9399b2;">.</span><span style="color: #89b4fa;">or</span><span style="color: #f38ba8;">(</span><span style="color: #a6e3a1;">'some_column.eq.Some value, other_column.eq.Other value'</span><span style="color: #f38ba8;">)</span>
</code></pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org17bc3e4" class="outline-2">
<h2 id="org17bc3e4"><span class="section-number-2">2.</span> Auth</h2>
<div class="outline-text-2" id="text-2">
<pre><code class="language-typescript-ts"><span style="color: #6c7086;">// obtain the user from supabase (always use this on server-side)</span>
<span style="color: #cba6f7;">const</span> <span style="color: #f38ba8;">{</span> data<span style="color: #9399b2;">:</span> <span style="color: #fab387;">{</span> <span style="color: #cdd6f4;">user</span> <span style="color: #fab387;">}</span> <span style="color: #f38ba8;">}</span> <span style="color: #89dceb;">=</span> <span style="color: #cba6f7;">await</span> supabase<span style="color: #9399b2;">.</span>auth<span style="color: #9399b2;">.</span><span style="color: #89b4fa;">getUser</span><span style="color: #f38ba8;">()</span><span style="color: #9399b2;">;</span>

<span style="color: #6c7086;">// obtain the user from supabase (faster client-side option)</span>
<span style="color: #89b4fa;">getSession</span><span style="color: #f38ba8;">()</span><span style="color: #9399b2;">.</span>session<span style="color: #9399b2;">.</span>user
</code></pre>
</div>
<div id="outline-container-org71e3c04" class="outline-3">
<h3 id="org71e3c04"><span class="section-number-3">2.1.</span> Custom Claims</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Supabase uses JWTs, or JSON Web Tokens, to store information about the identity and authentication of a user. You can add <i>custom claims</i> to these JWTs in order to add more information to the identity of a user, extending your application's functionality.
To do so, use a <a href="https://supabase.com/docs/guides/auth/auth-hooks/custom-access-token-hook">Custom Access Token Hook</a>. The custom access token hook runs before a token is issued and allows you to add additional claims based on the authentication method used:
</p>
<pre><code class="language-sql-ts"><span style="color: #cba6f7;">CREATE</span> OR <span style="color: #cba6f7;">REPLACE</span> <span style="color: #cba6f7;">FUNCTION</span> public.<span style="color: #f9e2af;">custom_access_token_hook</span><span style="color: #f38ba8;">(</span>event <span style="color: #f9e2af;">JSONB</span><span style="color: #f38ba8;">)</span>
<span style="color: #cba6f7;">RETURNS</span> <span style="color: #f9e2af;">JSONB</span>
<span style="color: #cba6f7;">LANGUAGE</span> plpgsql
<span style="color: #cba6f7;">AS</span> $$
  <span style="color: #cba6f7;">DECLARE</span>
    claims <span style="color: #f9e2af;">JSONB</span>;
    new_claim <span style="color: #f9e2af;">JSONB</span>;
  <span style="color: #cba6f7;">BEGIN</span>
    claims := event-&gt;'claims';
    claims := jsonb_set<span style="color: #f38ba8;">(</span>claims, '{new_claim}', new_claim<span style="color: #f38ba8;">)</span>;
    event := jsonb_set<span style="color: #f38ba8;">(</span>event, '{claims}', claims<span style="color: #f38ba8;">)</span>;
    <span style="color: #cba6f7;">RETURN</span> event;
  <span style="color: #cba6f7;">END</span>;
$$;
</code></pre>
</div>
<div id="outline-container-org98a48be" class="outline-4">
<h4 id="org98a48be"><span class="section-number-4">2.1.1.</span> Example: Role-Based Access Control</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
The general idea is we can use certain <i>permissions</i> granted to certain <i>roles</i> for use in RLS to have more fine-grained control over who gets to access what data. To do this, we can create an <code>app_permission</code> enum type to list out all the permissions, and an <code>app_role</code> enum type to list out all of the roles. Then, we can have a <code>user_roles</code> junction table to link a particular UUID with an <code>app_role</code>, and a <code>role_permissions</code> junction table to link specific roles to permissions.
</p>
<pre><code class="language-sql-ts"><span style="color: #6c7086;">-- CUSTOM TYPES</span>
<span style="color: #cba6f7;">CREATE</span> <span style="color: #cba6f7;">TYPE</span> public.<span style="color: #f9e2af;">app_permission</span> <span style="color: #cba6f7;">AS</span> <span style="color: #f9e2af;">ENUM</span> <span style="color: #f38ba8;">(</span><span style="color: #fab387;">'members.select'</span>, <span style="color: #fab387;">'members.update'</span>, <span style="color: #fab387;">'members.insert'</span><span style="color: #f38ba8;">)</span>;
<span style="color: #cba6f7;">CREATE</span> <span style="color: #cba6f7;">TYPE</span> public.<span style="color: #f9e2af;">app_role</span> <span style="color: #cba6f7;">AS</span> <span style="color: #f9e2af;">ENUM</span> <span style="color: #f38ba8;">(</span><span style="color: #fab387;">'admin'</span>, <span style="color: #fab387;">'member'</span><span style="color: #f38ba8;">)</span>;

<span style="color: #6c7086;">-- USER ROLES</span>
<span style="color: #cba6f7;">CREATE</span> <span style="color: #cba6f7;">TABLE</span> public.<span style="color: #f9e2af;">user_roles</span> <span style="color: #f38ba8;">(</span>
  id        <span style="color: #f9e2af;">BIGINT</span> <span style="color: #cba6f7;">GENERATED</span> BY <span style="color: #cba6f7;">DEFAULT</span> <span style="color: #cba6f7;">AS</span> IDENTITY <span style="color: #cba6f7;">PRIMARY</span> <span style="color: #cba6f7;">KEY</span>,
  user_id   <span style="color: #f9e2af;">UUID</span> <span style="color: #cba6f7;">REFERENCES</span> auth.<span style="color: #f9e2af;">users</span> ON <span style="color: #cba6f7;">DELETE</span> CASCADE NOT <span style="color: #f9e2af;">NULL</span>,
  role      <span style="color: #f9e2af;">app_role</span> NOT <span style="color: #f9e2af;">NULL</span>,
  UNIQUE <span style="color: #fab387;">(</span>user_id, role<span style="color: #fab387;">)</span>
<span style="color: #f38ba8;">)</span>;
<span style="color: #cba6f7;">COMMENT</span> ON <span style="color: #cba6f7;">TABLE</span> public.<span style="color: #f9e2af;">user_roles</span> <span style="color: #cba6f7;">IS</span> <span style="color: #fab387;">'Application roles for each user.'</span>;

<span style="color: #6c7086;">-- ROLE PERMISSIONS</span>
<span style="color: #cba6f7;">CREATE</span> <span style="color: #cba6f7;">TABLE</span> public.<span style="color: #f9e2af;">role_permissions</span> <span style="color: #f38ba8;">(</span>
  id          <span style="color: #f9e2af;">BIGINT</span> <span style="color: #cba6f7;">GENERATED</span> BY <span style="color: #cba6f7;">DEFAULT</span> <span style="color: #cba6f7;">AS</span> IDENTITY <span style="color: #cba6f7;">PRIMARY</span> <span style="color: #cba6f7;">KEY</span>,
  role        <span style="color: #f9e2af;">app_role</span> NOT <span style="color: #f9e2af;">NULL</span>,
  permission  <span style="color: #f9e2af;">app_permission</span> NOT <span style="color: #f9e2af;">NULL</span>,
  UNIQUE <span style="color: #fab387;">(</span>role, permission<span style="color: #fab387;">)</span>
<span style="color: #f38ba8;">)</span>;
<span style="color: #cba6f7;">COMMENT</span> ON <span style="color: #cba6f7;">TABLE</span> public.<span style="color: #f9e2af;">role_permissions</span> <span style="color: #cba6f7;">IS</span> <span style="color: #fab387;">'Application permissions for each role.'</span>;
</code></pre>
<p>
We can then insert into <code>public.role_permissions</code> the permissions for each role, like so:
</p>
<pre><code class="language-sql-ts"><span style="color: #cba6f7;">INSERT</span> <span style="color: #cba6f7;">INTO</span> public.<span style="color: #f9e2af;">role_permissions</span> <span style="color: #f38ba8;">(</span>role, permission<span style="color: #f38ba8;">)</span>
<span style="color: #cba6f7;">VALUES</span>  <span style="color: #f38ba8;">(</span><span style="color: #fab387;">'admin'</span>, <span style="color: #fab387;">'members.select'</span><span style="color: #f38ba8;">)</span>,  
        <span style="color: #f38ba8;">(</span><span style="color: #fab387;">'admin'</span>, <span style="color: #fab387;">'members.update'</span><span style="color: #f38ba8;">)</span>,
        <span style="color: #f38ba8;">(</span><span style="color: #fab387;">'admin'</span>, <span style="color: #fab387;">'members.insert'</span><span style="color: #f38ba8;">)</span>;
</code></pre>
<p>
In order for Supabase Auth to know what role an user is, we can now take advantage of the custom claims feature to add their role as a claim:
</p>
<pre><code class="language-sql-ts"><span style="color: #6c7086;">-- Create the auth hook function</span>
<span style="color: #cba6f7;">CREATE</span> OR <span style="color: #cba6f7;">REPLACE</span> <span style="color: #cba6f7;">FUNCTION</span> public.<span style="color: #f9e2af;">custom_access_token_hook</span><span style="color: #f38ba8;">(</span>event <span style="color: #f9e2af;">jsonb</span><span style="color: #f38ba8;">)</span>
<span style="color: #cba6f7;">RETURNS</span> <span style="color: #f9e2af;">jsonb</span>
<span style="color: #cba6f7;">LANGUAGE</span> plpgsql
<span style="color: #cba6f7;">STABLE</span>
<span style="color: #cba6f7;">AS</span> $$
  <span style="color: #cba6f7;">DECLARE</span>
    claims <span style="color: #f9e2af;">jsonb</span>;
    user_role public.<span style="color: #f9e2af;">app_role</span>;
  <span style="color: #cba6f7;">BEGIN</span>
    <span style="color: #6c7086;">-- Fetch the user role in the user_roles table</span>
    <span style="color: #cba6f7;">SELECT</span> role INTO user_role <span style="color: #cba6f7;">FROM</span> public.<span style="color: #f9e2af;">user_roles</span> <span style="color: #cba6f7;">WHERE</span> user_id = <span style="color: #f38ba8;">(</span>event-&gt;&gt;<span style="color: #fab387;">'user_id'</span><span style="color: #f38ba8;">)</span>::<span style="color: #f9e2af;">uuid</span>;

    claims := event-&gt;'claims';

    <span style="color: #cba6f7;">IF</span> user_role <span style="color: #cba6f7;">IS</span> NOT <span style="color: #f9e2af;">NULL</span> <span style="color: #cba6f7;">THEN</span>
      <span style="color: #6c7086;">-- Set the claim</span>
      claims := JSONB_SET<span style="color: #f38ba8;">(</span>claims, '{user_role}', TO_JSONB<span style="color: #fab387;">(</span>user_role<span style="color: #fab387;">)</span><span style="color: #f38ba8;">)</span>;
    <span style="color: #cba6f7;">ELSE</span>
      claims := JSONB_SET<span style="color: #f38ba8;">(</span>claims, '{user_role}', 'null'<span style="color: #f38ba8;">)</span>;
    <span style="color: #cba6f7;">END</span> IF;

    <span style="color: #6c7086;">-- Update the 'claims' object in the original event</span>
    event := JSONB_SET<span style="color: #f38ba8;">(</span>event, '{claims}', claims<span style="color: #f38ba8;">)</span>;

    <span style="color: #6c7086;">-- Return the modified or original event</span>
    <span style="color: #cba6f7;">RETURN</span> event;
  <span style="color: #cba6f7;">END</span>;
$$;

GRANT USAGE ON <span style="color: #cba6f7;">SCHEMA</span> public <span style="color: #cba6f7;">TO</span> supabase_auth_admin;

GRANT <span style="color: #cba6f7;">EXECUTE</span>
  ON <span style="color: #cba6f7;">FUNCTION</span> public.custom_access_token_hook
  <span style="color: #cba6f7;">TO</span> supabase_auth_admin;

REVOKE <span style="color: #cba6f7;">EXECUTE</span>
  ON <span style="color: #cba6f7;">FUNCTION</span> public.custom_access_token_hook
  <span style="color: #cba6f7;">FROM</span> authenticated, anon, public;

GRANT <span style="color: #cba6f7;">ALL</span>
  ON <span style="color: #cba6f7;">TABLE</span> public.user_roles
<span style="color: #cba6f7;">TO</span> supabase_auth_admin;

REVOKE <span style="color: #cba6f7;">ALL</span>
  ON <span style="color: #cba6f7;">TABLE</span> public.user_roles
  <span style="color: #cba6f7;">FROM</span> authenticated, anon, public;

<span style="color: #cba6f7;">CREATE</span> POLICY "Allow auth admin to read user roles" ON public.user_roles
<span style="color: #cba6f7;">AS</span> PERMISSIVE <span style="color: #cba6f7;">FOR</span> <span style="color: #cba6f7;">SELECT</span>
TO supabase_auth_admin
<span style="color: #cba6f7;">USING</span> <span style="color: #f38ba8;">(</span><span style="color: #fab387;">TRUE</span><span style="color: #f38ba8;">)</span>;
</code></pre>
<p>
To enable this function as a hook, in the dashboard, navigate to <a href="https://supabase.com/dashboard/project/_/auth/hooks">Authentication &gt; Hooks</a> and select the appropriate Postgres function from the dropdown menu.
</p>

<p>
Now, in order to use this information in our RLS policies, we can create a function called <code>authorize</code> to see if the user has the required permission:
</p>
<pre><code class="language-sql-ts"><span style="color: #cba6f7;">CREATE</span> OR <span style="color: #cba6f7;">REPLACE</span> <span style="color: #cba6f7;">FUNCTION</span> public.<span style="color: #f9e2af;">authorize</span><span style="color: #f38ba8;">(</span>
  requested_permission <span style="color: #f9e2af;">app_permission</span>
<span style="color: #f38ba8;">)</span>
<span style="color: #cba6f7;">RETURNS</span> <span style="color: #f9e2af;">boolean</span> <span style="color: #cba6f7;">AS</span> $$
<span style="color: #cba6f7;">DECLARE</span>
  bind_permissions <span style="color: #f9e2af;">int</span>;
  user_role public.<span style="color: #f9e2af;">app_role</span>;
<span style="color: #cba6f7;">BEGIN</span>
  <span style="color: #cba6f7;">SELECT</span> <span style="color: #f38ba8;">(</span>auth.<span style="color: #f9e2af;">jwt</span><span style="color: #fab387;">()</span> -&gt;&gt; <span style="color: #fab387;">'user_role'</span><span style="color: #f38ba8;">)</span>::public.<span style="color: #f9e2af;">app_role</span> INTO user_role;

  <span style="color: #cba6f7;">SELECT</span> <span style="color: #f9e2af;">COUNT</span><span style="color: #f38ba8;">(</span>*<span style="color: #f38ba8;">)</span>
  INTO bind_permissions
  <span style="color: #cba6f7;">FROM</span> public.<span style="color: #f9e2af;">role_permissions</span>
  <span style="color: #cba6f7;">WHERE</span> <span style="color: #f9e2af;">role_permissions</span>.permission = requested_permission
    AND <span style="color: #f9e2af;">role_permissions</span>.role = user_role;

  <span style="color: #cba6f7;">RETURN</span> bind_permissions &gt; <span style="color: #fab387;">0</span>;
<span style="color: #cba6f7;">END</span>;
$$ <span style="color: #cba6f7;">LANGUAGE</span> plpgsql <span style="color: #cba6f7;">STABLE</span> <span style="color: #cba6f7;">SECURITY</span> <span style="color: #cba6f7;">DEFINER</span> SET search_path = '';
</code></pre>
<p>
We can now use this function in our RLS policies, like so:
</p>
<pre><code class="language-sql-ts"><span style="color: #cba6f7;">CREATE</span> POLICY "Allow authorized select access"
ON "public"."members"
<span style="color: #cba6f7;">FOR</span> <span style="color: #cba6f7;">SELECT</span> TO authenticated <span style="color: #cba6f7;">USING</span> <span style="color: #f38ba8;">(</span>
  <span style="color: #fab387;">(</span><span style="color: #cba6f7;">SELECT</span> <span style="color: #f9e2af;">authorize</span><span style="color: #f9e2af;">(</span><span style="color: #fab387;">'members.select'</span><span style="color: #f9e2af;">)</span><span style="color: #fab387;">)</span>
<span style="color: #f38ba8;">)</span>;

<span style="color: #cba6f7;">CREATE</span> POLICY "Allow authorized update access"
ON "public"."members"
<span style="color: #cba6f7;">FOR</span> <span style="color: #cba6f7;">UPDATE</span> <span style="color: #f9e2af;">TO</span> authenticated <span style="color: #cba6f7;">USING</span> <span style="color: #f38ba8;">(</span>
  <span style="color: #fab387;">(</span><span style="color: #cba6f7;">SELECT</span> <span style="color: #f9e2af;">authorize</span><span style="color: #f9e2af;">(</span><span style="color: #fab387;">'members.update'</span><span style="color: #f9e2af;">)</span><span style="color: #fab387;">)</span>
<span style="color: #f38ba8;">)</span>;

<span style="color: #cba6f7;">CREATE</span> POLICY "Allow authorized insert access"
ON "public"."members"
<span style="color: #cba6f7;">FOR</span> <span style="color: #cba6f7;">INSERT</span> <span style="color: #f9e2af;">TO</span> authenticated <span style="color: #cba6f7;">WITH</span> CHECK <span style="color: #f38ba8;">(</span>
  <span style="color: #fab387;">(</span><span style="color: #cba6f7;">SELECT</span> <span style="color: #f9e2af;">authorize</span><span style="color: #f9e2af;">(</span><span style="color: #fab387;">'members.insert'</span><span style="color: #f9e2af;">)</span><span style="color: #fab387;">)</span>
<span style="color: #f38ba8;">)</span>;
</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<div class="footer">
               <p>Author: Lin Jiang</p>
             </div>
             <div class="last-modified">
               Last modified: 2025-05-31 23:21
             </div><script>
     window.addEventListener('DOMContentLoaded', (event) => {
         new PagefindUI({
            element: '#search',
            showSubResults: true,
            bundlePath: '/pagefind/'
         });
     });
    </script>
</div>
</body>
</html>
